name: CI - Continuous Integration

on:
  push:
    branches:
      - develop
      - main
  pull_request:
    branches:
      - develop
      - main

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9'

jobs:
  # Job 1: Lint e Type Check
  quality-check:
    name: Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ðŸ“š Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ” Run ESLint
        run: pnpm lint
        continue-on-error: true

      - name: ðŸ”Ž Type check
        run: pnpm tsc --noEmit
        continue-on-error: false

  # Job 2: Build Test
  build-test:
    name: Build Test
    runs-on: ubuntu-latest
    needs: quality-check
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ðŸ“š Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ”§ Create dummy .env.local
        run: |
          echo "NEXT_PUBLIC_SUPABASE_URL=https://dummy.supabase.co" > .env.local
          echo "NEXT_PUBLIC_SUPABASE_ANON_KEY=dummy_key" >> .env.local

      - name: ðŸ—ï¸ Build application
        run: pnpm build
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}

      - name: ðŸ“Š Upload build artifacts
        uses: actions/upload-artifact@v5
        with:
          name: build-output
          path: .next/
          retention-days: 7

  # Job 3: Security Check
  security-check:
    name: Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ðŸ”’ Run security audit
        run: pnpm audit --audit-level=high
        continue-on-error: true

      - name: ðŸ” Check for vulnerabilities
        run: pnpm audit --json > audit.json || true

      - name: ðŸ“Š Upload audit report
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: security-audit
          path: audit.json
          retention-days: 30

  # Job 4: Dependency Check
  dependency-check:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate

  # Job 5: Summary Report
  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [quality-check, build-test, security-check]
    if: always()
    
    steps:
      - name: ðŸ“Š Generate summary
        run: |
          echo "## ðŸŽ¯ CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Quality Check**: ${{ needs.quality-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Build Test**: ${{ needs.build-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Security Check**: ${{ needs.security-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”€ **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ‘¤ **Author**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
